define("Skwitch/Animation/Sequence",["./DOMView","Geo/Coordinate","Geo/D2Point","./Frame","objects/is","detect/detect"],function(e,t,n,r,i,s){return e.extend({"+options":{unformattedFramesInit:null,framesInit:null,domDesc:null,debug:!1,name:"untitled",weak:!1,forceRender:!1,security:null,size:null,keyInstant:null,parentEl:null},"+init":function(){this.framesInit&&!this.unformattedFramesInit&&(this.unformattedFramesInit=this.framesInit,this.framesInit=null),this.name&&!this.unformattedName&&(this.unformattedName=this.name),this.weak||this.build()},build:function(e){this._isBuilt||(this.doBuild(e),this._isBuilt=!0)},hide:function(){this.el&&(this.el.style.display="none")},show:function(){this.el&&(this.el.style.display="block")},doBuild:function(e){this.name=this.formatName(this.unformattedName),this.buildFrames(),this.renderFrame(0),this._a.on("resize",this.onResize.bind(this),this),delete this.unformattedFramesInit,delete this.unformattedName,delete this.framesInit},formatName:function(e){if(i("function",e))return e();if(i("string",e))return e},buildFrames:function(){this.frames=[],this.unformattedFramesInit&&(this.formatFramesInits(),this.setAttributesNames(),this.formattedFramesInits.each(function(e,t){this.frames.push(this.buildFrame(e,t))}.bind(this))),this.debug&&console.log("[debug]",this.name,this,"el",this.el,"parentEl",this.parentEl),this.debug&&console.log("[debug]",this.name,"frames",this.frames)},setAttributesNames:function(){this.attributesName=[],this.formattedFramesInits.each(function(e){for(var t in e.attributes)e.attributes.hasOwnProperty(t)&&(this.attributesName.has(t)||this.attributesName.push(t))}.bind(this))},formatFramesInits:function(){this.formattedFramesInits=[],this.formattedFramesInits=this.unformattedFramesInit.map(this.formatFrameInit.bind(this))},onResize:function(){this.destroy(),this.build(),this.render({force:!0})},render:function(e){var t;e=e||{};if(e.force&&this.currentFrame){if(this.currentFrame.between){e.between=this.currentFrame.betweenIndexes,e.r=this._a.timeline.appState,this.setCurrentFrameBetween(e);return}this.renderFrame(this.currentFrame.index);return}this.currentFrame&&(this.lastValues=this.currentFrame.getValues()),this.setCurrentFrame(e),this._renderAttributes()},_renderAttributes:function(){this.attributesName&&this.attributesName.each(this._renderAttribute.bind(this))},_renderAttribute:function(e){if(this.forceRender||this.el||this.canvasEl||this.raphaelEl){var t=this.currentFrame.attribute[e];this._isToBeRendered(t)&&this._doRenderAttribute(t)}},_isToBeRendered:function(e){return this.forceRender||!this.lastValues||this._hasValueUnequal(e)},_hasValueUnequal:function(e){return e.equals?!e.equals(this.lastValues[e.name]):this.lastValues[e.name]!==e.getValue()},_doRenderAttribute:function(e){this["_render"+e.name.capitalize()](e.getValue())},setCurrentFrame:function(e){if(e.isFrame){this.currentFrame=e;return}var t,n;if(e.between)this.setCurrentFrameBetween(e);else{t={previousFrame:this.currentFrame,instant:this._a.timeline.getAppState()},n=e,t.attributes=n;var r=this.formatFrameInit(t);this.currentFrame=this.buildFrame(r)}},setCurrentFrameBetween:function(e){e.now=this._a.timeline.appState,e.frameBetweens=e.between.map(function(e){return this.frames[e]}.bind(this)),this.currentFrame.isBetween(e.frameBetweens)?this._updateCurrentBetweenFrame(e):(this._buildNewCurrentBetweenFrame(e),this.debug==="frames"&&console.log("[debug]",this.name,"currentFrame",this.currentFrame))},_updateCurrentBetweenFrame:function(e){this.currentFrame.setValuesBetween(e.r)},_buildNewCurrentBetweenFrame:function(e){this.currentFrame=this.buildFrame({instant:e.now,between:e.frameBetweens,betweenIndexes:e.between,r:e.r,previousFrame:this.currentFrame})},renderFrameEnd:function(){this.renderFrame(this.frames.length-1)},renderFrame:function(e){var t=this.frames[e];t&&this.render(t)},isSequence:!0,formatFrameInit:function(e){var t=this.formatFrameTimeAndAttribute(e),n=t.attributes,r={};return i("array",n)?r.position=n:i("plainObject",n)?r=n:i("string",n)&&n==="fromName"&&(r.position="fromName"),{attributes:r,instant:t.instant,previousFrame:e.previousFrame||null}},formatFrameTimeAndAttribute:function(e){var t={};return i("array",e)?t={attributes:e[0],instant:e[1]}:i("plainObject",e)&&(t=e),t.instant=this.formatInstants(t.instant),t},formatInstants:function(e){var t;return i("string",e)?(e==="start",t=this.keyInstant[e]):i("number",e)&&(t=e),t},buildFrame:function(e,t){return this.sub(r,{index:t,unformattedAttributesInit:e.attributes,instant:e.instant,attributesName:this.attributesName,previousFrame:e.previousFrame||t&&this.frames[t-1]||null,sequenceName:this.name,between:e.between||null,r:e.r,betweenIndexes:e.betweenIndexes||null})},_renderRotate:function(e){this.css({rotate:e})},_renderSize:function(e){var t=e;this.el.style.width=t[0]+"px",this.el.style.height=t[1]+"px"},_renderColor:function(e){var t;if(s("isIE")&&s("IEVersion")<=8){e.length>3&&e.splice(3,1);var n=e.map(function(e){var t=e.toString(16);return t.length===1?"0"+t:t}).join("");t="#"+n}else t="rgba("+e.join()+")";this.css({color:t})},_renderOpacity:function(e){this.debug==="opacity"&&console.log(e),e<0&&(e=0),e>1&&(e=1),this.css({opacity:e})},_renderDisplay:function(e){this.debug==="display"&&console.log("[debug]",this.name,"display",e),e?this.el.style.display="block":this.el.style.display="none"},_renderPosition:function(e){var t=e.inRef("db").getValue();this.debug==="frames"&&console.log("[debug]",this.name,"p final",t),this.css({left:t[0]+"px",top:t[1]+"px"})},"+destroy":function(){this._isBuilt=!1}})});